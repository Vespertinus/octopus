
# This makefile based on ideas from http://make.paulandlesley.org/
# Thanks to Paul D. Smith <psmith@gnu.org>

export LC_ALL=C

.SUFFIXES:
.SECONDARY:

CORO_IMPL ?= ASM

@SET_MAKE@
CC := @CC@
CFLAGS := @CFLAGS@
CFLAGS_WARNS := @CFLAGS_WARNS@
CPPFLAGS := @CPPFLAGS@
LDFLAGS := @LDFLAGS@
RAGEL := @RAGEL@
RAGELFLAGS := @RAGELFLAGS@
CONFETTI := @CONFETTI@
GIT := @GIT@
HAVE_GIT := @HAVE_GIT@
DARCS := @DARCS@
HAVE_DARCS := @HAVE_DARCS@
ECHO := @ECHO@
CAT := cat
SED := @SED@
NM := @NM@
OBJCOPY := @OBJCOPY@
HAVE_RAGEL := @HAVE_RAGEL@
HAVE_CONFETTI := @HAVE_CONFETTI@
HAVE_LCOV := @HAVE_LCOV@
COVERAGE := @COVERAGE@
LIBS := @LIBS@
HAVE_CC_FLAG_W_NO_COMMENT := @HAVE_CC_FLAG_W_NO_COMMENT@
HAVE_CC_FLAG_W_NO_UNUSED_VALUE := @HAVE_CC_FLAG_W_NO_UNUSED_VALUE@
modules := @modules@
srcdir := @srcdir@
VPATH := @srcdir@

MAKEFLAGS += --no-print-directory

CFLAGS += -I. -Iinclude
ifneq (.,$(srcdir))
    CFLAGS += -I$(srcdir) -I$(srcdir)/include
endif

CFLAGS += -Wno-strict-aliasing -funwind-tables

ifeq ("$(origin V)", "command line")
    VERBOSE = $(V)
endif
ifeq (,$(VERBOSE))
  E:=@echo
  Q:=@
else
  E:=@:
  Q:=
endif


all: tarantool

subdirs += third_party $(foreach module,$(modules),mod/$(module)) cfg src src-lua
include $(foreach dir,$(subdirs),$(srcdir)/$(dir)/Makefile)

tarantool: $(obj)
	$E "CC	$@"
	$Q$(CC) $(LDFLAGS) $^ $(LIBS) -o $@

LDFLAGS += -Lthird_party/luajit/src -Wl,--export-dynamic
LIBS += -lluajit
tarantool: third_party/luajit/src/libluajit.a
third_party/luajit/src/libluajit.a:
	$(E) "MAKE	$@"
	@$(MAKE) -C third_party/luajit/src CC="$(CC)" E="$(E)" Q="$(Q)" \
		TARGET_CFLAGS='-funwind-tables -DLUAJIT_UNWIND_EXTERNAL' libluajit.a

$(obj): $(foreach dir,$(subdirs),$(srcdir)/$(dir)/Makefile)
$(obj): Makefile

dep = $(patsubst %.o,%.d,$(obj))
-include $(dep)

$(filter-out $(disable-warns-obj),$(obj)): CFLAGS += $(CFLAGS_WARNS)

%.o: %.m
	@mkdir -p $(dir $@)
	$(E) "CC	$@"
	$(Q)$(CC) $(CPPFLAGS) $(CFLAGS) -Wno-protocol -fobjc-exceptions -fgnu-runtime -c $< -o $@

%.o: %.c
	@mkdir -p $(dir $@)
	$(E) "CC	$@"
	$(Q)$(CC) $(CPPFLAGS) $(CFLAGS) -c $< -o $@

ifeq (1,$(HAVE_RAGEL))
%.m: %.rl
	@mkdir -p $(dir $@)
	$(E) "RAGEL	$@"
	$(Q)$(RAGEL) -G2 $< -o $@

%.dot: %.rl
	@mkdir -p $(dir $@)
	$(E) "RAGEL	$@"
	$(Q)$(RAGEL) -p -V $< -o $(basename $@).dot

%.png: %.dot
	@mkdir -p $(dir $@)
	$(E) "DOT	$@"
	$(Q)$(DOT) -Tpng $< -o $(basename $@).png
endif

ifeq (1,$(HAVE_CONFETTI))
%.cfg: %.cfg_tmpl
	@mkdir -p $(dir $@)
	$(E) "CNFTY	$@"
	$(Q)$(CONFETTI) -i $< -n tarantool_cfg -f $@

%.h: %.cfg_tmpl
	@mkdir -p $(dir $@)
	$(E) "CNFTY	$@"
	$(Q)$(CONFETTI) -i $< -n tarantool_cfg -h $@

%.c: %.cfg_tmpl
	@mkdir -p $(dir $@)
	$(E) "CNFTY	$@"
	$(Q)$(CONFETTI) -i $< -n tarantool_cfg -c $@
endif


FORCE:
.PHONY: FORCE
ifeq (1,$(HAVE_DARCS))
tarantool_version.h: FORCE
	@echo -n 'const char tarantool_version_string[] = "' > $@_
	@DARCS=$(DARCS) sh $(srcdir)/scripts/darcs-describe >> $@_
	@echo '";' >> $@_
	@diff -q $@ $@_ 2>/dev/null >/dev/null || (echo "GEN	$(notdir $@)"; cp $@_ $@)
	@rm $@_
else
ifeq (1,$(HAVE_GIT))
tarantool_version.h: FORCE
	@echo -n 'const char tarantool_version_string[] = "' > $@_
	@$(GIT) describe HEAD | tr -d \\n >> $@_
	@echo '";' >> $@_
	@diff -q $@ $@_ 2>/dev/null >/dev/null || (echo "GEN	$(notdir $@)"; cp $@_ $@)
	@rm $@_
endif
endif

.PHONY: distclean clean
clean:
	@echo "CLEAN tarantool"
	@rm -rf $(obj) $(patsubst %.o,%.gcno,$(obj))
	@rm -rf $(dep) tarantool lcov test/var

luaclean:
	@$(MAKE) -C third_party/luajit/src clean

configure-byproducts += autom4te.cache config.log config.status
configure-byproducts += include/config.h Makefile scripts/gen-lua-registry.sh

distclean: clean luaclean
	@rm -rf $(dist-clean)
	@rm -rf $(configure-byproducts) configure install.sh
	@rm -rf TAGS test/var test/*.rej

.PHONY: TAGS
TAGS:
	find $(srcdir) -name \*.[mch] | etags -

.PHONY: test
test:	tarantool
	ruby test/runtest.rb

ifeq (1,$(COVERAGE))
clean: clean-coverage
ifeq (1,$(HAVE_LCOV))
tarantool.cov: $(patsubst %.o,%.gcda,$(obj)) $(patsubst %.o,%.gcno,$(obj))
	lcov --output-file $@ --base-directory . --capture --directory .
	lcov --output-file $@ --remove $@ y.tab.c prscfg.l prscfg.y prscfg_scan.c /usr/\*
tarantool.coverage/index.html: tarantool.cov
	genhtml --output-directory $(dir $@) $<
else
tarantool.cov: $(patsubst %.o,%.gcda,$(obj)) $(patsubst %.o,%.gcno,$(obj))
	python scripts/zcov/zcov-scan $@
tarantool.coverage/index.html: tarantool.cov
	python scripts/zcov/zcov-genhtml $< $(dir $@)
endif

$(patsubst %.o,%.gcda,$(obj)): test

.PHONY: coverage clean-coverage
coverage: tarantool.coverage/index.html
	sensible-browser $<

clean-coverage:
	@rm -rf $(patsubst %.o,%.gcda,$(obj)) \
		tarantool.coverage tarantool.cov
endif


Makefile: $(srcdir)/config.status $(srcdir)/include/config.h.in $(srcdir)/Makefile.in
	./config.status

config.status: $(srcdir)/configure
	./config.status --recheck

configure: $(srcdir)/configure.ac $(srcdir)/third_party/libev/libev.m4
	cd $(srcdir) && autoconf

.PHONY:
dist: configure $(dist) tarantool_version.h
	@rm -rf $(configure-byproducts)

$(eval $(defered))

ifeq (1,$(I))
    $(info * build with $(filter -D%,$(CFLAGS)))
endif

