
# This makefile based on ideas from http://make.paulandlesley.org/
# Thanks to Paul D. Smith <psmith@gnu.org>

export LC_ALL=C

.SUFFIXES:
.SECONDARY:

CORO_IMPL ?= ASM

@SET_MAKE@
CC := @CC@
CFLAGS := @CFLAGS@
CFLAGS_WARNS := @CFLAGS_WARNS@
CPPFLAGS := @CPPFLAGS@
LDFLAGS := @LDFLAGS@
RANLIB := @RANLIB@
AR := ar
ARFLAGS := rc
RAGEL := @RAGEL@
RAGELFLAGS := @RAGELFLAGS@
DOT := @DOT@
CONFETTI := @CONFETTI@
GIT := @GIT@
HAVE_GIT := @HAVE_GIT@
DARCS := @DARCS@
HAVE_DARCS := @HAVE_DARCS@
ECHO := @ECHO@
CAT := cat
SED := @SED@
NM := @NM@
OBJCOPY := @OBJCOPY@
HAVE_RAGEL := @HAVE_RAGEL@
HAVE_CONFETTI := @HAVE_CONFETTI@
HAVE_LCOV := @HAVE_LCOV@
COVERAGE := @COVERAGE@
LIBS := @LIBS@
HAVE_CC_FLAG_W_NO_COMMENT := @HAVE_CC_FLAG_W_NO_COMMENT@
HAVE_CC_FLAG_W_NO_UNUSED_VALUE := @HAVE_CC_FLAG_W_NO_UNUSED_VALUE@
modules := @modules@
clients := @clients@
srcdir := @srcdir@
VPATH := @srcdir@

MAKEFLAGS += --no-print-directory

CFLAGS += -I. -Iinclude
ifneq (.,$(srcdir))
    CFLAGS += -I$(srcdir) -I$(srcdir)/include
endif

CFLAGS += -Wno-strict-aliasing -funwind-tables

ifeq ("$(origin V)", "command line")
    VERBOSE = $(V)
endif
ifeq (,$(VERBOSE))
  E:=@echo
  Q:=@
else
  E:=@:
  Q:=
endif

depend = $(patsubst %.o,%.d,$(1))

all: octopus $(foreach client,$(clients),$(client)_all)

subdirs += $(foreach module,$(modules),mod/$(module))
subdirs += $(wildcard client/*)
subdirs += third_party cfg src src-lua

sub-Makefile = $(foreach dir,$(subdirs),$(srcdir)/$(dir)/Makefile)
-include $(sub-Makefile)

ifneq ($(findstring src/paxos.o,$(obj)),)
  CFLAGS += -DPAXOS
endif

octopus: $(obj)
	$E "CC	$@"
	$Q$(CC) $(LDFLAGS) $^ $(LIBS) -o $@

octopus: LDFLAGS += -Wl,--wrap=malloc -Wl,--wrap=calloc -Wl,--wrap=realloc
octopus: LDFLAGS += -Lthird_party/luajit/src -Wl,--export-dynamic
octopus: LIBS += -lluajit
octopus: third_party/luajit/src/libluajit.a
third_party/luajit/src/libluajit.a:
	$(E) "MAKE	$@"
	@$(MAKE) -C third_party/luajit/src CC="$(CC)" E="$(E)" Q="$(Q)" \
		TARGET_CFLAGS='-funwind-tables -DLUAJIT_UNWIND_EXTERNAL' libluajit.a

$(obj): Makefile $(sub-Makefile)

dep += $(call depend,$(obj))
-include $(dep)

$(filter-out $(disable-warns-obj),$(obj)): CFLAGS += $(CFLAGS_WARNS)

%.o: %.m
	@mkdir -p $(dir $@)
	$(E) "CC	$@"
	$(Q)$(CC) $(CPPFLAGS) $(CFLAGS) -Wno-protocol -fobjc-exceptions -c $< -o $@

%.o: %.c
	@mkdir -p $(dir $@)
	$(E) "CC	$@"
	$(Q)$(CC) $(CPPFLAGS) $(CFLAGS) -c $< -o $@

ifeq (1,$(HAVE_RAGEL))
%.m: %.rl
	@mkdir -p $(dir $@)
	$(E) "RAGEL	$@"
	$(Q)$(RAGEL) -G2 $< -o $@

%.dot: %.rl
	@mkdir -p $(dir $@)
	$(E) "RAGEL	$@"
	$(Q)$(RAGEL) -p -V $< -o $(basename $@).dot

%.png: %.dot
	@mkdir -p $(dir $@)
	$(E) "DOT	$@"
	$(Q)$(DOT) -Tpng $< -o $(basename $@).png
endif

ifeq (1,$(HAVE_CONFETTI))
%.cfg: %.cfg_tmpl
	@mkdir -p $(dir $@)
	$(E) "CNFTI	$@"
	$(Q)$(CONFETTI) -i $< -n octopus_cfg -f $@

cfg/%.h: cfg/%.cfg_tmpl
	@mkdir -p $(dir $@)
	$(E) "CNFTI	$@"
	$(Q)$(CONFETTI) -i $< -n octopus_cfg -h $@

cfg/%.c: cfg/%.cfg_tmpl
	@mkdir -p $(dir $@)
	$(E) "CNFTI	$@"
	$(Q)$(CONFETTI) -i $< -n octopus_cfg -c $@
endif


FORCE:
.PHONY: FORCE
ifeq (1,$(HAVE_DARCS))
octopus_version.h: FORCE
	@echo -n 'const char octopus_version_string[] = "' > $@_
	@DARCS=$(DARCS) sh $(srcdir)/scripts/darcs-describe >> $@_
	@echo '";' >> $@_
	@diff -q $@ $@_ 2>/dev/null >/dev/null || (echo "GEN	$(notdir $@)"; cp $@_ $@)
	@rm $@_
else
ifeq (1,$(HAVE_GIT))
octopus_version.h: FORCE
	@echo -n 'const char octopus_version_string[] = "' > $@_
	@$(GIT) describe --always HEAD | tr -d \\n >> $@_
	@echo -n - >> $@_
	@$(GIT) branch | grep  '\*' | cut -f2 -d' ' | sed 's/^master$$/experimental/' | tr -d \\n >> $@_
	@echo '";' >> $@_
	@diff -q $@ $@_ 2>/dev/null >/dev/null || (echo "GEN	$(notdir $@)"; cp $@_ $@)
	@rm $@_
endif
endif

scripts/stringify: scripts/stringify.c
	$(Q)$(CC) $< -o $@
	$(E) "CC	$@"

.PHONY: distclean clean
clean:
	$(E) "CLEAN	octopus"
	$(Q)rm -rf $(obj) $(patsubst %.o,%.gcno,$(obj))
	$(Q)rm -rf $(dep) octopus lcov test/var

luaclean:
	$(E) "CLEAN	luajit"
	$(Q)$(MAKE) -C third_party/luajit/src clean

configure-byproducts += autom4te.cache config.log config.status
configure-byproducts += include/config.h Makefile

distclean: clean luaclean
	$(Q)rm -rf $(dist-clean)
	$(Q)rm -rf $(configure-byproducts) configure install.sh
	$(Q)rm -rf TAGS test/var test/*.rej

.PHONY: TAGS
TAGS:
	ctags-exuberant --langmap=ObjectiveC:.m.h.rl -eR

.PHONY: test
test:	octopus
	test/run.rb

ifeq (1,$(COVERAGE))
clean: clean-coverage
ifeq (1,$(HAVE_LCOV))
octopus.cov: $(patsubst %.o,%.gcda,$(obj)) $(patsubst %.o,%.gcno,$(obj))
	lcov --output-file $@ --base-directory . --capture --directory .
	lcov --output-file $@ --remove $@ y.tab.c prscfg.l prscfg.y prscfg_scan.c /usr/\*
octopus.coverage/index.html: octopus.cov
	genhtml --output-directory $(dir $@) $<
else
octopus.cov: $(patsubst %.o,%.gcda,$(obj)) $(patsubst %.o,%.gcno,$(obj))
	python scripts/zcov/zcov-scan $@
octopus.coverage/index.html: octopus.cov
	python scripts/zcov/zcov-genhtml $< $(dir $@)
endif

$(patsubst %.o,%.gcda,$(obj)): test

.PHONY: coverage clean-coverage
coverage: octopus.coverage/index.html
	sensible-browser $<

clean-coverage:
	@rm -rf $(patsubst %.o,%.gcda,$(obj)) \
		octopus.coverage octopus.cov
endif


Makefile: $(srcdir)/config.status $(srcdir)/include/config.h.in $(srcdir)/Makefile.in $(sub-Makefile)
	./config.status

config.status: $(srcdir)/configure
	./config.status --recheck

configure: $(srcdir)/configure.ac $(srcdir)/third_party/libev/libev.m4
	cd $(srcdir) && autoconf

ifeq (1,$(HAVE_DARCS))
dist += darcs.context
.PHONY: darcs.context
darcs.context:
	$E "DARCS	$@"
	$Q$(DARCS) changes --repodir=$(or $(REPODIR),".") --context > darcs.context
endif

.PHONY:
dist: configure $(dist) octopus_version.h
	@rm -rf $(configure-byproducts)

$(eval $(defered))

ifeq (1,$(I))
    $(info * build with $(filter -D%,$(CFLAGS)))
endif

